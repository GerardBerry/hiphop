#!/bin/bash

if [ -z "$HOPBIN" ]; then
    HOPBIN=hop
fi

space="     "
dir=$(pwd)
hop="/usr/local/bin/$HOPBIN"
hop_opt="--no-server --no-sofile -q"
CC=/usr/bin/gcc
batchfile=/tmp/batch.js
output_hop=/tmp/TEST-HOPJS.out
verb=
debug=

run_test() {
  i=$((i + 1))
  file=$1
  suf=$2

    echo -n "$i. $file$suf ... "

    if [ -f $file.in ]; then
	cat <<EOF > $batchfile
"use hopscript"
"use strict"

const batch = require("hiphop");
let test = require("$dir/$file$suf.js", "hiphop");

if (test.prg)
   try {
      batch.batch(test.prg);
   } catch(e){
      console.log(e.message);
      process.exit(1);
   }
EOF
	if [ "$verb " != " " ]; then
	  echo "$hop $hop_opt $batchfile"
	fi
	$hop $hop_opt $batchfile < $file.in > $output_hop
    else
	$hop $hop_opt $file.js > $output_hop
    fi
    diff_out=$(diff $output_hop $file.out)

    if [ "$diff_out" != "" ]
    then
	echo -en "\x1B[31m\x1B[1mfailure\x1B[0m"
	failure=$(($failure+1))

	if [ "$debug " != " " ]; then
	  cat $output_hop
	  exit 1
	fi
    else
	echo -en "\x1B[32m\x1B[1mok\x1B[0m"
	success=$(($success+1))
    fi

    echo ".";
}

init_stats() {
    i=0
    success=0
    failure=0
}

print_stats() {
    echo -e "\x1B[1m$space*** $success success   $failure failure ***\x1B[0m"
}

if [ "$(dirname $0)" != "." ]
then
    echo "ERROR: The tests must be run inside test directory"
    exit 1
fi

while : ; do
  case $1 in
    "")
      break;;

    -v)
      verb="$verb -v";;

    -g)
      debug=yes;
      hop_opt+=" -g";;

    *)
      break
  esac

  shift
done

init_stats

echo -e "\x1B[1m$space*** HIPHOP.JS TESTS ***\x1B[0m"

if [ "$1 " != " " ]; then
  file=`basename $1 .js`
  file=`basename $file .hh`
  
  if [ "$file.js" = $1 -a -f $file.js ]; then
    run_test $file
  fi
  if [ "$file.hh.js" = $1 -a -f $file.hh.js ]; then
    run_test $file .hh
  fi
else
  for file in *.out; do
    file=${file%.*}
    if [ -f $file.js ]; then
      run_test $file
    fi
    if [ -f $file.hh.js ]; then
      run_test $file .hh
    fi
  done
fi

print_stats

rm $batchfile
rm $output_hop
