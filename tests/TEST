#!/bin/bash

dir=$(pwd)
hop=/usr/local/bin/hop
js2esterel=/tmp/js2esterel.js
batch=/tmp/batch.js
CC=/usr/bin/gcc
output_hop=/tmp/TEST-HOPJS.out
output_est=/tmp/TEST-EST.out

batch_esterel() {
    $ESTEREL/bin/esterel -simul $file.strl -D /tmp/ \
    	&& $CC /tmp/$file.c $ESTEREL/lib/libcoresim.a \
    	       -o /tmp/$file \
	&& /tmp/$file \
    	&& rm /tmp/$file /tmp/$file.c
}

run_kernel_test() {
    i=$((i + 1))

    echo -n "$i. $file ... "

    cat <<EOF > $batch
"use hopscript"
var batch = require("$dir/../batch-interpreter.js");
example = require("$dir/$file.js"); // global for eval_mode
batch.interpreter(example.prg);
EOF

    $hop -g --no-server $batch < $file.in > $output_hop

    if [ -f "$file.strl" ]
    then
	batch_esterel $file < $file.in > $output_est
	diff_out=$(diff -Z $output_hop $output_est)
    else
	diff_out=$(diff $output_hop $file.out)
    fi

    if [ "$diff_out" != "" ]
    then
	echo -en "\e[31m\e[1mfailure\e[0m"
	failure=`expr $failure + 1`
    else
	echo -en "\e[32m\e[1mok\e[0m"
	success=`expr $success + 1`
    fi

    echo ".";
}

run_js2esterel_test() {
    i=$((i + 1))

    echo -n "$i. $file ... "

    cat <<EOF > $js2esterel
"use hopscript"
var js2esterel = require("$dir/../js2esterel.js");
var example = require("$dir/$file.js");
console.log(example.prg.esterel_code());
EOF

    $hop -g --no-server $js2esterel < $file.in > $output_hop

    if [ "$(diff -Z $output_hop $file-js2esterel.out)" != "" ]
    then
	echo -en "\e[31m\e[1mfailure\e[0m"
	failure=`expr $failure + 1`
    else
	echo -en "\e[32m\e[1mok\e[0m"
	success=`expr $success + 1`
    fi

    echo ".";
}

init_stats() {
    i=0
    success=0
    failure=0
}

print_stats() {
    echo "`expr $success + $failure` executed"
    echo "   $success success"
    echo "   $failure failure"
}

if [ -z $ESTEREL ]
then
    echo "ERROR: Esterel needs to be installed."
    exit 1
fi

if [ "$(dirname $0)" != "." ]
then
    echo "ERROR: The tests must be run inside test directory"
    exit 1
fi

clear

if [[ "$1" != "" && -f $1.in && ("$2" == "kernel" || "$2" == "js2esterel") ]]
then
    file=$1
    echo "*** DEBUG $2 TEST FOR $file. TMP FILES WILL NOT BE REMOVED ***"
    if [ "$2" == "kernel" ]
    then
	run_kernel_test
    else
	run_js2esterel_test
    fi
    exit 0
fi

init_stats
echo -e "\e[1mkernel tests...\e[0m"
for file in *.in
do
    file=${file%.*}
    run_kernel_test
done
print_stats

init_stats
echo -e "\n\e[1mjs2esterel tests...\e[0m"
for file in *-js2esterel.out
do
    file=${file%-js2esterel.out}
    run_js2esterel_test
done
print_stats

rm $batch
rm $js2esterel
rm $output_est
rm $output_hop
