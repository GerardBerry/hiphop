#* Generated file, don't edit
#*=====================================================================*/
#*    serrano/prgm/project/hiphop/hiphop/Makefile.in                   */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Fri Jan 20 14:35:57 2006                          */
#*    Last change :  Fri May  1 06:41:26 2020 (serrano)                */
#*    Copyright   :  2006-20 Manuel Serrano                            */
#*    -------------------------------------------------------------    */
#*    Generic Makefile to build Hop weblets.                           */
#*=====================================================================*/
## run "make" to build the .hz file

#*---------------------------------------------------------------------*/
#*    Weblet description                                               */
#*---------------------------------------------------------------------*/
HZ=@HZ@
HZVERSION=@VERSION@
DATE="@DATE@"

CATEGORY=programming
LICENSE=@LICENSE@

LIBDIR=@LIBDIR@
HOPREPOSITORY=@HOPREPOSITORY@
HOPLIBDIR=@HOPLIBDIR@
HOPVERSION=@HOPVERSION@
HOPBUILDID=@HOPBUILDID@
HOPBUILDARCH=@HOPBUILDARCH@
HOPSODIR=@SODIR@

HOP = @HOP@
HOPC = @HOPC@
HFLAGS = @HFLAGS@

LIB = ast.js batch.js compiler.js compiler-utils.js debugger-common.js \
 debugger.js debugger-server.js debug.js error.js hiphop.js lang.js \
 machine.js net.js queue.js signal.js sweep.js

PREPROCESSOR = astutils.js _hhaccess.hop parser.js

ULIB = parallelmap.js

OBJECTS = $(LIB:%=lib/%) $(PREPROCESSOR:%=preprocessor/%) $(ULIB:%=ulib/%)
SOFILES = $(OBJECTS:%.js=%.so)

SODIR= @SODIR@
JSDIR = $(LIBDIR)/$(RELEASE)

SO=$(SOFILES:%=so/%)

#*---------------------------------------------------------------------*/
#*    do                                                               */
#*---------------------------------------------------------------------*/
do: $(SOFILES) lib/config.so ChangeLog
	@ echo "Compilation complete."

#*---------------------------------------------------------------------*/
#*    .suffixes                                                        */
#*---------------------------------------------------------------------*/
.SUFFIXES:
.SUFFIXES: .js .so

#*---------------------------------------------------------------------*/
#*    The implicit rules                                               */
#*---------------------------------------------------------------------*/
%.so: %.js
	$(HOPC) $(HFLAGS) -y -o $@ $< 

#*---------------------------------------------------------------------*/
#*    install                                                          */
#*---------------------------------------------------------------------*/
install:
	mkdir -p $(DESTDIR)$(LIBDIR)
	mkdir -p $(DESTDIR)$(LIBDIR)/$(HZVERSION)
	cp -rf lib $(DESTDIR)$(LIBDIR)/$(HZVERSION)
	cp -rf preprocessor $(DESTDIR)$(LIBDIR)/$(HZVERSION)
	cp -rf ulib $(DESTDIR)$(LIBDIR)/$(HZVERSION)
	cp package.json $(DESTDIR)$(LIBDIR)/$(HZVERSION)
	chmod -R a+rx $(DESTDIR)$(LIBDIR)
	find $(DESTDIR)$(LIBDIR) -name '*.so' -exec touch {} \;
	echo "Installation complete [$(DESTDIR)$(LIBDIR)/$(HZVERSION)]."

#*---------------------------------------------------------------------*/
#*    clean                                                            */
#*---------------------------------------------------------------------*/
clean:
	rm -rf so
	rm -rf lib/so
	rm -rf ulib/so
	rm -rf preprocessor/so

cleanall: clean
	rm -f config.status
	rm -f lib/config.js
	rm -rf arch/debian/debian

distclean: cleanall

#*---------------------------------------------------------------------*/
#*    hz                                                               */
#*---------------------------------------------------------------------*/
.PHONY: distrib tgz

distrib: hz
hz: tgz
tgz: $(HOPREPOSITORY)/$(HZ)-$(HZVERSION).tar.gz

$(HOPREPOSITORY)/$(HZ)-$(HZVERSION).tar.gz: \
  package.json \
  package-lock.json \
  node_modules \
  ulib \
  lib \
  preprocessor \
  configure \
  Makefile.in Makefile \
  $(OBJECTS) \
  $(FILES) \
  LICENSE \
  arch \
  docker \
  etc \
  doc \
  .travis.yml.in \
  ChangeLog
	mkdir -p $(HOPREPOSITORY) && \
	(cd ..; \
	 cp -r $(HZ) $(HZ)-$(HZVERSION); \
         tar cvfz $@ \
             --exclude='$(HZ)/private' \
             --exclude=.gitignore \
             --exclude=.git \
             --exclude=so \
             --exclude=arch/debian/build.$(HZ) \
             --exclude='*~' $(^:%=$(HZ)-$(HZVERSION)/%); \
         rm -rf $(HZ)-$(HZVERSION))

#*---------------------------------------------------------------------*/
#*    ChangeLog                                                        */
#*---------------------------------------------------------------------*/
ChangeLog:
	git log --pretty=format:"hiphop ($(HZVERSION)-1) unstable; urgency=low%n%n  * %s%n%n -- %an <%ae>  %cD%n" > ChangeLog
